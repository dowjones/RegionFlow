/**
 * regionflow v0.1.1
 * @author: Adrian Lafond, Dow Jones Newsroom Development
 * @license: MIT
 */
!function(e){"use strict";function t(){var e=arguments[0],i=null,s=null,u=null,a=null;if(e&&e.nodeType===d)i=e;else if(e&&n(e)===r)i=document.querySelector(e);else if(n(e)===h)return t(e.region,e.content,e.ellipse,e.endsign);if(i){if(s=arguments[1]&&n(arguments[1])===r?arguments[1]:i.innerHTML,!s)return null;u=arguments[2]&&n(arguments[2])===r?arguments[2]:null,a=arguments[3]&&n(arguments[3])===r?arguments[3]:null;var f=new o(i,s,u,a);return l(f.contentXml)}throw'RegionFlow error: "region" could not be defined.'}function n(e){return Object.prototype.toString.call(e)}function o(e,t,n,o){var i;this.region=e,this.bounds=e.getBoundingClientRect(),this.contentXml=s(t),n?(i=document.createElement("p"),i.innerHTML=n,this.ellipse=i.textContent):this.ellipse=null,o?(i=document.createElement("p"),i.innerHTML=o,this.endsign=i.textContent):this.endsign=null,this.prevTextNode=null,this.nodesToRemove=[],this.flowComplete=!1,this.region.innerHTML="",this.region.style.height="auto",this.flow(this.contentXml,this.region),this.removeFlowedNodes(),this.endsign&&this.flowComplete&&this.removeEllipse(this.endsign),this.region.style.height=this.bounds.height+"px"}function i(e){return""===e||/^\s+$/m.test(e)}function s(e){var t=document.createElement("div");return t.innerHTML=e,t}function l(e){for(var t,n=new XMLSerializer,o="",i=0,s=e.childNodes.length;s>i;i++)t=e.childNodes[i],(t.nodeType===d||t.nodeType===u)&&(o+=n.serializeToString(t));return o}var r="[object String]",h="[object Object]",d=1,u=3,a=" ,:;.?-–—/\\'\"“”‘’‛‟′″[]{}()".split(""),f=a.length,p=" ";o.prototype={flow:function(e,t){for(var n=!!e.textContent,o=e.firstChild;o;o=o.nextSibling){switch(o.nodeType){case d:this.flowNode(o,t);break;case u:this.flowText(o,t)}if(this.flowComplete)break}(!n||n&&!e.textContent)&&this.nodesToRemove.push(e)},flowNode:function(e,t){var n,o,i=e.cloneNode(!1),s=!!e.textContent;if(t.appendChild(i),this.fitComplete||this.overflows())return void t.removeChild(i);for(var l=e.firstChild;l;l=l.nextSibling){switch(l.nodeType){case d:o=!!l.textContent,n=l.cloneNode(!1),i.appendChild(n),this.flow(l,n),o&&!n.textContent&&i.removeChild(n);break;case u:this.flowText(l,i)}if(this.flowComplete)break}(!s||s&&!e.textContent)&&this.nodesToRemove.push(e)},flowText:function(e,t){var n,o,s,l,r=this.asWordBlocks(e.nodeValue),h=e.cloneNode(!1),d=i(e.nodeValue),u=this.ellipse&&!d?this.ellipse:"",a=this.endsign&&!d?this.endsign:"";u&&(l=this.removeEllipse()),a&&(l=this.removeEllipse(a),r.push(a)),h.nodeValue=n="",t.appendChild(h);for(var f=0,p=r.length;p>f;f++){if(o=[n,r[f]].join(""),s=u?o+u:o,h.nodeValue=s,this.overflows()){i(n)?(h.nodeValue=n,this.prevTextNode&&(this.prevTextNode.nodeValue=l+u)):(this.removeEllipse(),h.nodeValue=[n.replace(/\s+$/,""),u].join("")),a&&(r=r.slice(0,p-1));break}h.nodeValue=o,n=o}e.nodeValue=r.slice(f).join(""),e.nodeValue||this.nodesToRemove.push(e),(u||a)&&h.nodeValue&&(this.prevTextNode=h)},removeEllipse:function(e){var t=null;if(e=e||this.ellipse,this.prevTextNode&&e){t=this.prevTextNode.nodeValue;var n=t.lastIndexOf(e);-1!==n&&(this.prevTextNode.nodeValue=t.substr(0,t.length-e.length))}return t},asWordBlocks:function(e){var t,n,o,i,s,l=[],r=e.split(""),h="";for(t=0,n=r.length;n>t;t++){for(i=r[t],h+=i,o=0;f>o;o++)if(i===a[o]){(h!==p||h===p&&s!==p)&&l.push(h),s=h,h="";break}t===n-1&&""!==h&&l.push(h)}return l},overflows:function(){return this.flowComplete=this.region.getBoundingClientRect().height>this.bounds.height,this.flowComplete},removeFlowedNodes:function(){for(var e,t=0,n=this.nodesToRemove.length;n>t;t++)e=this.nodesToRemove[t],e.parentNode&&e.parentNode.removeChild(e)}},"function"==typeof define&&define.amd?define(function(){return t}):e.regionflow=t}(this);